name: Cross Platform Validation

on:
  pull_request:
  workflow_dispatch:

jobs:
  error-paths:
    name: Error Paths (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . pytest

      - name: Run cross-platform error-path tests
        env:
          PNP_STRESS_ITERATIONS: "8"
          PNP_STRESS_RETRY_SAMPLES: "16"
          PNP_STRESS_SEED: "17"
        run: |
          pytest -q \
            tests/test_runtime_error_envelope.py \
            tests/test_resolver_classifier_golden.py \
            tests/test_fault_injection_harness.py \
            tests/test_fault_injection_stress.py

  shell-editor-matrix:
    name: Shell/Editor (${{ matrix.os }} / ${{ matrix.shell }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            shell: bash
          - os: ubuntu-latest
            shell: pwsh
          - os: macos-latest
            shell: bash
          - os: windows-latest
            shell: pwsh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: ${{ matrix.shell }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . pytest

      - name: Run editor/remediation validation tests
        shell: ${{ matrix.shell }}
        run: |
          pytest -q \
            tests/test_ops_editor_matrix.py \
            tests/test_remediation_policy.py
